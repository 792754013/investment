# ARCHITECTURE.md — 约束 × 需求 投资操作系统（v1）

> 目标：构建一套**可长期运行、可审计、可复盘**的投资决策系统。  
> 核心思想：用“约束驱动 + 需求触发”的因果结构，替代传统价格预测模型。

> 非目标：不直接预测价格、不依赖黑箱模型、不追逐短期情绪。

---

# 一、系统总体说明

本系统把现实世界中分散的信号（产业、政策、需求、供给、风险）  
转化为标准化事件，然后通过**13 步决策流水线**，输出：

- 可投资主题
- 可投资节点 / 标的
- 入场 / 加仓 / 减仓 / 退出意图
- 风险控制动作（止损 / 止盈 / 停机）

核心原则：

- **约束是火药，需求是火星**
- 优先使用“因果结构”，而不是统计相关
- 模型（机器学习）只能作为**增强器**，不能做最终决策

---

# 二、系统分层架构（非常重要）

┌────────────────────────────┐
│ 研究 / 监控层 │ ← 可视化、复盘、人工判断
└──────────────┬─────────────┘
│（标准化数据）
┌──────────────▼─────────────┐
│ 决策层（13步流水线） │ ← 只做判断，不读原始数据
└──────────────┬─────────────┘
│（事件 / 因子 / 风险状态）
┌──────────────▼─────────────┐
│ 信号层（构建器） │ ← 把原始数据变成信号
└──────────────┬─────────────┘
│（只读）
┌──────────────▼─────────────┐
│ 数据层（原始数据） │ ← 价格、公告、Capex、招标等
└────────────────────────────┘


### 分层铁律
- 决策层 **不能直接读原始数据**
- 数据层 **不能包含任何决策逻辑**
- 层与层之间只能用“契约结构”通信

---

# 三、各层职责说明

---

## 3.1 数据层（Data Layer）

**职责：**
- 获取并存储所有原始数据（价格、成交量、公告、招标、Capex、政策）
- 提供时间快照（可回放）
- 记录数据来源，保证可追溯

**禁止：**
- 不做任何判断
- 不计算分数
- 不输出交易信号

---

## 3.2 信号层（Signal Layer）

**职责：**
- 把原始数据转换成“事件”和“信号”
- 构建需求事件、约束健康度、因子、风险信号
- 可使用规则或机器学习，但必须输出标准结构

**输出示例：**
- 需求事件（DemandEvent）
- 约束快照（ConstraintSnapshot）
- 因子表（FactorFrame）
- 市场风险状态（RiskState）

---

## 3.3 决策层（Decision Layer）

**职责：**
- 严格按 13 步执行决策
- 所有决策必须可解释、可审计
- 输出“交易意图”，不是直接下单

**禁止：**
- 读原始数据
- 依赖不可解释模型
- 跳过步骤

---

## 3.4 研究 / 监控层（Research Layer）

**职责：**
- 可视化系统状态
- 复盘历史决策
- 分析失败原因
- 不参与实时决策

---

# 四、数据契约（必须统一）

---

## 4.1 需求事件（DemandEvent）

表示一个“需求冲击”或“需求加速”事件。

字段：
- id：事件ID
- theme：主题
- energy：需求强度（1-5）
- duration：持续性（1-5）
- growth：增速（1-5）
- confidence：可信度（0-100）
- timestamp：时间
- source：来源
- meta：扩展字段（结构化）

---

## 4.2 约束（Constraint）

表示一个长期存在、不可快速加速的瓶颈。

字段：
- id
- industry
- constraint_type（物理 / 技术 / 资本 / 政策）
- hardness（1-5，不可加速程度）
- expand_cycle_months（扩产周期）
- profit_concentration（利润集中度）
- substitute_risk（替代风险）
- controller（控制方）
- status（ACTIVE / INACTIVE）

---

## 4.3 约束快照（ConstraintSnapshot）

表示当前约束是否仍然“有效”。

字段：
- constraint_id
- health_score（0-100）
- break_risk（0-1）
- drivers（原因）
- timestamp

---

## 4.4 风险状态（RiskState）

表示当前市场是否适合交易。

字段：
- market_regime（风险偏好）
- liquidity_state（流动性）
- policy_risk（政策风险）
- crowding_state（拥挤度）
- timestamp

---

# 五、决策契约（所有步骤必须输出）

每一步都必须返回：

```text
DecisionResult {
  step,
  decision,
  confidence,
  reason[],
  metrics{},
  timestamp
}
